<?php

declare(strict_types=1);

namespace Stadly\PasswordPolice\DateFormatter;

use DateTime;
use PHPUnit\Framework\TestCase;
use Stadly\PasswordPolice\CharTree;
use Stadly\PasswordPolice\Formatter;

/**
 * @coversDefaultClass \Stadly\PasswordPolice\DateFormatter\DefaultFormatter
 * @covers ::<private>
 * @covers ::<protected>
 * @covers ::__construct
 */
final class DefaultFormatterTest extends TestCase
{
    /**
     * @covers ::apply
     */
    public function testCanFormatDates(): void
    {
        $formatter = new DefaultFormatter();

        self::assertSame(CharTree::fromArray([
            CharTree::fromString('20010203'),
            CharTree::fromString('2001 02 03'),
            CharTree::fromString('2001-02-03'),
            CharTree::fromString('2001/02/03'),
            CharTree::fromString('2001.02.03'),
            CharTree::fromString('010203'),
            CharTree::fromString('01 02 03'),
            CharTree::fromString('01-02-03'),
            CharTree::fromString('01/02/03'),
            CharTree::fromString('01.02.03'),
            CharTree::fromString('200123'),
            CharTree::fromString('2001 2 3'),
            CharTree::fromString('2001-2-3'),
            CharTree::fromString('2001/2/3'),
            CharTree::fromString('2001.2.3'),
            CharTree::fromString('0123'),
            CharTree::fromString('01 2 3'),
            CharTree::fromString('01-2-3'),
            CharTree::fromString('01/2/3'),
            CharTree::fromString('01.2.3'),
            CharTree::fromString('02032001'),
            CharTree::fromString('02 03 2001'),
            CharTree::fromString('02-03-2001'),
            CharTree::fromString('02/03/2001'),
            CharTree::fromString('02.03.2001'),
            CharTree::fromString('020301'),
            CharTree::fromString('02 03 01'),
            CharTree::fromString('02-03-01'),
            CharTree::fromString('02/03/01'),
            CharTree::fromString('02.03.01'),
            CharTree::fromString('232001'),
            CharTree::fromString('2 3 2001'),
            CharTree::fromString('2-3-2001'),
            CharTree::fromString('2/3/2001'),
            CharTree::fromString('2.3.2001'),
            CharTree::fromString('2301'),
            CharTree::fromString('2 3 01'),
            CharTree::fromString('2-3-01'),
            CharTree::fromString('2/3/01'),
            CharTree::fromString('2.3.01'),
            CharTree::fromString('03022001'),
            CharTree::fromString('03 02 2001'),
            CharTree::fromString('03-02-2001'),
            CharTree::fromString('03/02/2001'),
            CharTree::fromString('03.02.2001'),
            CharTree::fromString('030201'),
            CharTree::fromString('03 02 01'),
            CharTree::fromString('03-02-01'),
            CharTree::fromString('03/02/01'),
            CharTree::fromString('03.02.01'),
            CharTree::fromString('322001'),
            CharTree::fromString('3 2 2001'),
            CharTree::fromString('3-2-2001'),
            CharTree::fromString('3/2/2001'),
            CharTree::fromString('3.2.2001'),
            CharTree::fromString('3201'),
            CharTree::fromString('3 2 01'),
            CharTree::fromString('3-2-01'),
            CharTree::fromString('3/2/01'),
            CharTree::fromString('3.2.01'),
            CharTree::fromString('19071119'),
            CharTree::fromString('1907 11 19'),
            CharTree::fromString('1907-11-19'),
            CharTree::fromString('1907/11/19'),
            CharTree::fromString('1907.11.19'),
            CharTree::fromString('071119'),
            CharTree::fromString('07 11 19'),
            CharTree::fromString('07-11-19'),
            CharTree::fromString('07/11/19'),
            CharTree::fromString('07.11.19'),
            CharTree::fromString('19071119'),
            CharTree::fromString('1907 11 19'),
            CharTree::fromString('1907-11-19'),
            CharTree::fromString('1907/11/19'),
            CharTree::fromString('1907.11.19'),
            CharTree::fromString('071119'),
            CharTree::fromString('07 11 19'),
            CharTree::fromString('07-11-19'),
            CharTree::fromString('07/11/19'),
            CharTree::fromString('07.11.19'),
            CharTree::fromString('11191907'),
            CharTree::fromString('11 19 1907'),
            CharTree::fromString('11-19-1907'),
            CharTree::fromString('11/19/1907'),
            CharTree::fromString('11.19.1907'),
            CharTree::fromString('111907'),
            CharTree::fromString('11 19 07'),
            CharTree::fromString('11-19-07'),
            CharTree::fromString('11/19/07'),
            CharTree::fromString('11.19.07'),
            CharTree::fromString('11191907'),
            CharTree::fromString('11 19 1907'),
            CharTree::fromString('11-19-1907'),
            CharTree::fromString('11/19/1907'),
            CharTree::fromString('11.19.1907'),
            CharTree::fromString('111907'),
            CharTree::fromString('11 19 07'),
            CharTree::fromString('11-19-07'),
            CharTree::fromString('11/19/07'),
            CharTree::fromString('11.19.07'),
            CharTree::fromString('19111907'),
            CharTree::fromString('19 11 1907'),
            CharTree::fromString('19-11-1907'),
            CharTree::fromString('19/11/1907'),
            CharTree::fromString('19.11.1907'),
            CharTree::fromString('191107'),
            CharTree::fromString('19 11 07'),
            CharTree::fromString('19-11-07'),
            CharTree::fromString('19/11/07'),
            CharTree::fromString('19.11.07'),
            CharTree::fromString('19111907'),
            CharTree::fromString('19 11 1907'),
            CharTree::fromString('19-11-1907'),
            CharTree::fromString('19/11/1907'),
            CharTree::fromString('19.11.1907'),
            CharTree::fromString('191107'),
            CharTree::fromString('19 11 07'),
            CharTree::fromString('19-11-07'),
            CharTree::fromString('19/11/07'),
            CharTree::fromString('19.11.07'),
        ]), $formatter->apply([
            new DateTime('2001-02-03 07:11:19'),
            new DateTime('1907-11-19 21:13:58'),
        ]));
    }

    /**
     * @covers ::apply
     */
    public function testCanApplyFormatterChain(): void
    {
        $formatter = new DefaultFormatter();

        $next = $this->createMock(Formatter::class);
        $next->method('apply')->willReturnCallback(
            static function (CharTree $charTree): CharTree {
                $charTrees = [];
                foreach ($charTree as $string) {
                    $charTrees[] = CharTree::fromString(strrev($string));
                }
                return CharTree::fromArray($charTrees);
            }
        );

        $formatter->setNext($next);

        self::assertSame(CharTree::fromArray([
            CharTree::fromString('30201002'),
            CharTree::fromString('30 20 1002'),
            CharTree::fromString('30-20-1002'),
            CharTree::fromString('30/20/1002'),
            CharTree::fromString('30.20.1002'),
            CharTree::fromString('302010'),
            CharTree::fromString('30 20 10'),
            CharTree::fromString('30-20-10'),
            CharTree::fromString('30/20/10'),
            CharTree::fromString('30.20.10'),
            CharTree::fromString('321002'),
            CharTree::fromString('3 2 1002'),
            CharTree::fromString('3-2-1002'),
            CharTree::fromString('3/2/1002'),
            CharTree::fromString('3.2.1002'),
            CharTree::fromString('3210'),
            CharTree::fromString('3 2 10'),
            CharTree::fromString('3-2-10'),
            CharTree::fromString('3/2/10'),
            CharTree::fromString('3.2.10'),
            CharTree::fromString('10023020'),
            CharTree::fromString('1002 30 20'),
            CharTree::fromString('1002-30-20'),
            CharTree::fromString('1002/30/20'),
            CharTree::fromString('1002.30.20'),
            CharTree::fromString('103020'),
            CharTree::fromString('10 30 20'),
            CharTree::fromString('10-30-20'),
            CharTree::fromString('10/30/20'),
            CharTree::fromString('10.30.20'),
            CharTree::fromString('100232'),
            CharTree::fromString('1002 3 2'),
            CharTree::fromString('1002-3-2'),
            CharTree::fromString('1002/3/2'),
            CharTree::fromString('1002.3.2'),
            CharTree::fromString('1032'),
            CharTree::fromString('10 3 2'),
            CharTree::fromString('10-3-2'),
            CharTree::fromString('10/3/2'),
            CharTree::fromString('10.3.2'),
            CharTree::fromString('10022030'),
            CharTree::fromString('1002 20 30'),
            CharTree::fromString('1002-20-30'),
            CharTree::fromString('1002/20/30'),
            CharTree::fromString('1002.20.30'),
            CharTree::fromString('102030'),
            CharTree::fromString('10 20 30'),
            CharTree::fromString('10-20-30'),
            CharTree::fromString('10/20/30'),
            CharTree::fromString('10.20.30'),
            CharTree::fromString('100223'),
            CharTree::fromString('1002 2 3'),
            CharTree::fromString('1002-2-3'),
            CharTree::fromString('1002/2/3'),
            CharTree::fromString('1002.2.3'),
            CharTree::fromString('1023'),
            CharTree::fromString('10 2 3'),
            CharTree::fromString('10-2-3'),
            CharTree::fromString('10/2/3'),
            CharTree::fromString('10.2.3'),
            CharTree::fromString('91117091'),
            CharTree::fromString('91 11 7091'),
            CharTree::fromString('91-11-7091'),
            CharTree::fromString('91/11/7091'),
            CharTree::fromString('91.11.7091'),
            CharTree::fromString('911170'),
            CharTree::fromString('91 11 70'),
            CharTree::fromString('91-11-70'),
            CharTree::fromString('91/11/70'),
            CharTree::fromString('91.11.70'),
            CharTree::fromString('91117091'),
            CharTree::fromString('91 11 7091'),
            CharTree::fromString('91-11-7091'),
            CharTree::fromString('91/11/7091'),
            CharTree::fromString('91.11.7091'),
            CharTree::fromString('911170'),
            CharTree::fromString('91 11 70'),
            CharTree::fromString('91-11-70'),
            CharTree::fromString('91/11/70'),
            CharTree::fromString('91.11.70'),
            CharTree::fromString('70919111'),
            CharTree::fromString('7091 91 11'),
            CharTree::fromString('7091-91-11'),
            CharTree::fromString('7091/91/11'),
            CharTree::fromString('7091.91.11'),
            CharTree::fromString('709111'),
            CharTree::fromString('70 91 11'),
            CharTree::fromString('70-91-11'),
            CharTree::fromString('70/91/11'),
            CharTree::fromString('70.91.11'),
            CharTree::fromString('70919111'),
            CharTree::fromString('7091 91 11'),
            CharTree::fromString('7091-91-11'),
            CharTree::fromString('7091/91/11'),
            CharTree::fromString('7091.91.11'),
            CharTree::fromString('709111'),
            CharTree::fromString('70 91 11'),
            CharTree::fromString('70-91-11'),
            CharTree::fromString('70/91/11'),
            CharTree::fromString('70.91.11'),
            CharTree::fromString('70911191'),
            CharTree::fromString('7091 11 91'),
            CharTree::fromString('7091-11-91'),
            CharTree::fromString('7091/11/91'),
            CharTree::fromString('7091.11.91'),
            CharTree::fromString('701191'),
            CharTree::fromString('70 11 91'),
            CharTree::fromString('70-11-91'),
            CharTree::fromString('70/11/91'),
            CharTree::fromString('70.11.91'),
            CharTree::fromString('70911191'),
            CharTree::fromString('7091 11 91'),
            CharTree::fromString('7091-11-91'),
            CharTree::fromString('7091/11/91'),
            CharTree::fromString('7091.11.91'),
            CharTree::fromString('701191'),
            CharTree::fromString('70 11 91'),
            CharTree::fromString('70-11-91'),
            CharTree::fromString('70/11/91'),
            CharTree::fromString('70.11.91'),
        ]), $formatter->apply([
            new DateTime('2001-02-03 07:11:19'),
            new DateTime('1907-11-19 21:13:58'),
        ]));
    }
}
